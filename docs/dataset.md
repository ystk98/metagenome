# Overview
This document is record of procedure to create training (& others) datasets.

# 00_download_gtdb
## Objective
- Download GTDB release 226.0 representative genomes & other files to generate training dataset & other analysis
## Command
- 2025-12-11 Setup
```shell
    (hyena) yasutake@luna:~/research/projects/metagenome$ mkdir /nfs_share/yasutake/projects/metagenome/gtdb
    (hyena) yasutake@luna:~/research/projects/metagenome$ ln -s /nfs_share/yasutake/projects/metagenome/gtdb ./data/gtdb
```
- 2025-12-11 Download GTDB
```shell
    (hyena) yasutake@luna:~/research/projects/metagenome$ tmux new -s download
    yasutake@luna:~/research/projects/metagenome/analyses/00_download_gtdb$ bash download.sh
```

# 01_gtdb_reps_analysis
## Objective
- Determine genomes to include training dataset
## Method
- Generate concatenated & extended metadata
- Analyse metadata
## Command
- 2025-12-12 Unfreeze GTDB representative genomes
```shell
    (hyena) yasutake@luna:~/research/projects/metagenome/data/gtdb/226.0$ grep "gtdb_genomes_reps_r226.tar.gz" MD5SUM.txt | md5sum -c - # check whether file broken
    ./genomic_files_reps/gtdb_genomes_reps_r226.tar.gz: OK
    (hyena) yasutake@luna:~/research/projects/metagenome/data/gtdb$ tar -I pigz -xvf gtdb_genomes_reps_r226.tar.gz
```
- 2025-12-12 Get profile of gtdb representatives
```shell
    (hyena) yasutake@luna:~/research/projects/metagenome/analyses/01_gtdb_reps_analysis$ python profile_gtdb_reps.py 
```

# 02_split_plasmids
## Objective
- Split plasmids from genomes
## Method
- Filter plasmids based on each header information of a genome
## Command
- 2025-12-14 Create directory on /nfs_share & symbolic link
```shell
    (hyena) yasutake@luna:~/research/projects/metagenome$ mkdir -p /nfs_share/yasutake/projects/metagenome/gtdb_split/226.0
    (hyena) yasutake@luna:~/research/projects/metagenome$ ln -s /nfs_share/yasutake/projects/metagenome/gtdb_split/226.0 ./data/gtdb_split/226.0
```
- 2025-12-15 Perform split
```shell
    (hyena) yasutake@luna:~/research/projects/metagenome$ python analyses/02_split_plasmids/split_plasmids.py
```
## Note
- 2025-12-21 On detection reason of split_summary.csv.
    - **Issue**: Original `split_plasmids.py` recorded detection reasons only in FASTA headers, missing them in `split_summary.csv`.
    - **Resolution**: Ran a patch script (`notebooks/patch_detect_reason.ipynb`) to extract reasons from generated files and merge them into the CSV.
    - **Future work**: This logic should be integrated into the main script (`split_plasmids.py`) for future runs.
- 2025-12-21 Data Integrity Assessment & Decision to Re-run
    - **Observation**: During the visualization of `split_summary.csv`, specific error logs (`CRC check failed`, `Compressed file ended before end-of-stream`) were detected in the reason columns (ref. `notebooks/split_summary_stats.ipynb`) .
    - **Root Cause**: These errors were likely caused by manual interruptions (`Ctrl+C`) during the initial single-process execution, which took approx. 4.5 days.
    - **Risk**: There is a possibility of "silent corruption" (e.g., truncated files that were recorded as success in CSV but are physically incomplete). Using this dataset poses a significant risk to downstream model training (e.g., DataLoader crashes).
    - **Decision**: Instead of surgically repairing specific files, **the entire dataset will be re-generated** to ensure scientific integrity.
    - **Action Plan**:
        1.  Refactor script `split_genomes.py` using `multiprocessing` to drastically reduce processing time.
        2.  Implement atomic write operations and immediate file size validation to prevent corrupted files from being registered.
        3.  The logic for "detection reason" logging (previously patched) will be natively integrated into the new script.

# 03_generate_manifest
## Objective
- Generate manifest file to genedate training dataset
## Command
- 2025-12-14 Perform generation with isolated genomes only
```shell
    yasutake@luna:~/research/projects/metagenome$ python analyses/02_generate_manifest/generate_manifest.py 
```

# 04_generate_dataset
## Objective
- Generate training dataset
## Method
- Training dataset contains contigs & its species label
- Each contigs are generated by cropping original genomes
- The number of contigs are determined by mean genome coverage
- Once sampled region's sampling probability is decayed by its sampled number
    - In this research, I do not allocate sampling probs to complementary sequences. This means to prioritize physical coverage than representative coverage.
- Plasmids which can be detected by sequence header are eliminated or labeled (determined by config)
## Command
- 2025-12-14 Create directory on /nfs_share & symbolic link in analysis dir.
```shell
    (hyena) yasutake@luna:~/research/projects/metagenome$ mkdir /nfs_share/yasutake/projects/metagenome/train
    (hyena) yasutake@luna:~/research/projects/metagenome$ ln -s /nfs_share/yasutake/projects/metagenome/train ./data/train
```
- 2025/12/XX
```shell

```